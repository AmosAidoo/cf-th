<!-- This UI was mostly generated with AI -->
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Solar Lead Pipeline - Dashboard</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
		/*  Custom animations */
		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(-10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.fade-in {
			animation: fadeIn 0.3s ease-out;
		}
	</style>
</head>

<body class="bg-gray-50 min-h-screen">
	<div class="container mx-auto px-4 py-8 max-w-7xl">
		<!--  Header -->
		<div class="mb-8">
			<h1 class="text-4xl font-bold text-gray-900 mb-2">üåû Solar Lead Pipeline</h1>
			<p class="text-gray-600">Test and monitor your lead generation workflow</p>
		</div>

		<!--  Success/Error Messages -->
		<% if (typeof success !=='undefined' && success==='true' ) { %>
			<div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-6 fade-in">
				<p class="font-semibold">‚úì Lead generation triggered successfully!</p>
				<p class="text-sm">Check the results below in a moment...</p>
			</div>
			<% } %>

				<% if (typeof error !=='undefined' ) { %>
					<div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6 fade-in">
						<p class="font-semibold">‚úó Error:</p>
						<p class="text-sm">
							<%= decodeURIComponent(error) %>
						</p>
					</div>
					<% } %>

						<!--  Configuration Info -->
						<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
							<h2 class="text-lg font-semibold text-gray-900 mb-4">‚öôÔ∏è Configuration</h2>
							<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
								<div>
									<p class="text-gray-500 font-medium">User ID</p>
									<p class="text-gray-900 font-mono">
										<%= config.userId %>
									</p>
								</div>
								<div>
									<p class="text-gray-500 font-medium">Zipcode Filter</p>
									<p class="text-gray-900 font-mono">
										<%= config.zipcodePrefix %>***
									</p>
								</div>
								<div>
									<p class="text-gray-500 font-medium">Webhook URL</p>
									<p id="pWebhookUrl" class="text-gray-900 font-mono text-xs">
										<%= config.webhookUrl %>
									</p>
								</div>
							</div>
						</div>

						<!-- Trigger Section with loading state and auto-retry -->
						<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
							<h2 class="text-lg font-semibold text-gray-900 mb-4">üöÄ Trigger Lead Generation</h2>
							<p class="text-gray-600 mb-4">Click the button below to request a test lead from the API. The lead will be sent to
								your webhook and processed automatically.</p>
						
							<form action="/trigger" id="triggerForm">
								<div class="flex gap-3">
									<button type="submit" id="triggerButton"
										class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors duration-200 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed inline-flex items-center gap-2">
										<span id="buttonText">Generate Test Lead</span>
									</button>

									<button type="button" id="autoRetryButton"
										class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors duration-200 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed inline-flex items-center gap-2">
										<svg id="autoRetrySpinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg"
											fill="none" viewBox="0 0 24 24">
											<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
											<path class="opacity-75" fill="currentColor"
												d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
											</path>
										</svg>
										<span id="autoRetryText">Auto-Generate Until Success</span>
									</button>
						
									<!-- Stop button (hidden by default) -->
									<button type="button" id="stopButton"
										class="bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors duration-200 shadow-sm hidden">
										Stop
									</button>
								</div>
						
								<!-- Auto-retry status display -->
								<div id="autoRetryStatus" class="mt-4 hidden">
									<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
										<p class="text-sm font-semibold text-blue-900 mb-2">Auto-generating leads...</p>
										<div class="space-y-1 text-xs text-blue-800">
											<p>Attempts: <span id="attemptCount" class="font-bold">0</span></p>
											<p>Filtered: <span id="filteredCount" class="font-bold">0</span></p>
											<p>Errors: <span id="errorCount" class="font-bold">0</span></p>
											<p class="text-blue-600 italic" id="statusMessage">Starting...</p>
										</div>
									</div>
								</div>
							</form>
						</div>

						<!--  Recent Leads Section -->
						<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
							<div class="flex items-center justify-between mb-4">
								<h2 class="text-lg font-semibold text-gray-900">üìä Recent Leads (<%= recentLeads.length %>)</h2>
								<% if (recentLeads.length> 0) { %>
									<form method="POST" action="/clear" class="inline">
										<button type="submit" class="text-sm text-red-600 hover:text-red-700 font-medium">
											Clear All
										</button>
									</form>
									<% } %>
							</div>

							<% if (recentLeads.length===0) { %>
								<div class="text-center py-12">
									<p class="text-gray-400 text-lg">No leads processed yet</p>
									<p class="text-gray-400 text-sm mt-2">Click "Generate Test Lead" to get started</p>
								</div>
								<% } else { %>
									<div class="space-y-4">
										<% recentLeads.forEach((lead, index)=> { %>
											<div class="border border-gray-200 rounded-lg p-4 fade-in">
												<!--  Lead Header -->
												<div class="flex items-start justify-between mb-3">
													<div class="flex items-center gap-3">
														<% if (lead.status==='success' ) { %>
															<span
																class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
																‚úì Sent to Customer
															</span>
															<% } else if (lead.status==='filtered' ) { %>
																<span
																	class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">
																	‚äò Filtered
																</span>
																<% } else if (lead.status==='error' ) { %>
																	<span
																		class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
																		‚úó Error
																	</span>
																	<% } %>
													</div>
													<p class="text-xs text-gray-500">
														<%= new Date(lead.timestamp).toLocaleString() %>
													</p>
												</div>

												<!--  Lead Details -->
												<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-3">
													<div>
														<p class="text-gray-500 font-medium">Contact</p>
														<p class="text-gray-900">
															<%= lead.originalLead.first_name %>
																<%= lead.originalLead.last_name %>
														</p>
														<p class="text-gray-600 text-xs">
															<%= lead.originalLead.email %>
														</p>
														<p class="text-gray-600 text-xs">
															<%= lead.originalLead.phone %>
														</p>
													</div>
													<div>
														<p class="text-gray-500 font-medium">Location</p>
														<p class="text-gray-900">
															<%= lead.originalLead.zipcode %>
																<%= lead.originalLead.city %>
														</p>
														<p class="text-gray-600 text-xs">
															<%= lead.originalLead.street %>
														</p>
													</div>
												</div>

												<!--  Status Reason -->
												<% if (lead.reason) { %>
													<div class="bg-gray-50 rounded px-3 py-2 mb-3">
														<p class="text-xs text-gray-600"><strong>Reason:</strong>
															<%= lead.reason %>
														</p>
													</div>
													<% } %>

														<!--  Warnings -->
														<% if (lead.warnings && lead.warnings.length> 0) { %>
															<div class="bg-yellow-50 border border-yellow-200 rounded px-3 py-2 mb-3">
																<p class="text-xs font-semibold text-yellow-800 mb-1">
																	‚ö†Ô∏è <%= lead.warnings.length %> Warning(s)
																</p>
																<ul class="text-xs text-yellow-700 space-y-1">
																	<% lead.warnings.forEach(warning=> { %>
																		<li>‚Ä¢ <%= warning.reason %>: <%= warning.question %> = "<%= warning.answer %>"</li>
																		<% }) %>
																</ul>
															</div>
															<% } %>

																<!--  Customer Response -->
																<% if (lead.customerResponse) { %>
																	<div class="bg-green-50 border border-green-200 rounded px-3 py-2 mb-3">
																		<p class="text-xs font-semibold text-green-800 mb-1">Customer API Response</p>
																		<pre
																			class="text-xs text-green-700 overflow-x-auto"><%= JSON.stringify(lead.customerResponse, null, 2) %></pre>
																	</div>
																	<% } %>

																		<!--  Collapsible Details -->
																		<details class="mt-3">
																			<summary
																				class="cursor-pointer text-sm text-blue-600 hover:text-blue-700 font-medium">
																				View Full Details
																			</summary>
																			<div class="mt-3 space-y-3">
																				<!-- Original Lead -->
																				<div>
																					<p class="text-xs font-semibold text-gray-700 mb-1">Original Lead Data</p>
																					<pre
																						class="bg-gray-50 rounded p-2 text-xs overflow-x-auto"><%= JSON.stringify(lead.originalLead, null, 2) %></pre>
																				</div>

																				<!-- Transformed Lead -->
																				<% if (lead.transformedLead) { %>
																					<div>
																						<p class="text-xs font-semibold text-gray-700 mb-1">Transformed Lead (Sent
																							to
																							Customer)</p>
																						<pre
																							class="bg-gray-50 rounded p-2 text-xs overflow-x-auto"><%= JSON.stringify(lead.transformedLead, null, 2) %></pre>
																					</div>
																					<% } %>
																			</div>
																		</details>
											</div>
											<% }) %>
									</div>
									<% } %>
						</div>
	</div>

	<!--  Auto-refresh script (optional, refreshes every 5 seconds if a lead was just triggered) -->
	<script>
		// Auto-retry functionality
			let autoRetryActive = false;
			let attemptCount = 0;
			let filteredCount = 0;
			let errorCount = 0;

			async function triggerLead(webhookUrl) {
				const response = await fetch('/trigger', {
					redirect: 'manual' // Don't follow redirects automatically
				});

				// Since the server redirects, we need to check the location header
				// or just wait and check the recent leads
				await new Promise(resolve => setTimeout(resolve, 2000)); // Wait for processing

				// Fetch the latest lead status
				const statusResponse = await fetch('/api/latest-lead');
				return await statusResponse.json();
			}

			document.getElementById('autoRetryButton').addEventListener('click', async function () {
				const webhookUrl = document.getElementById('pWebhookUrl').textContent;
				const autoRetryButton = document.getElementById('autoRetryButton');
				const autoRetryText = document.getElementById('autoRetryText');
				const autoRetrySpinner = document.getElementById('autoRetrySpinner');
				const stopButton = document.getElementById('stopButton');
				const autoRetryStatus = document.getElementById('autoRetryStatus');
				const statusMessage = document.getElementById('statusMessage');
				const triggerButton = document.getElementById('triggerButton');

				// Reset counters
				attemptCount = 0;
				filteredCount = 0;
				errorCount = 0;
				autoRetryActive = true;

				// Update UI
				autoRetryButton.disabled = true;
				triggerButton.disabled = true;
				autoRetrySpinner.classList.remove('hidden');
				autoRetryText.textContent = 'Generating...';
				stopButton.classList.remove('hidden');
				autoRetryStatus.classList.remove('hidden');

				// Auto-retry loop
				while (autoRetryActive) {
					attemptCount++;
					document.getElementById('attemptCount').textContent = attemptCount;
					statusMessage.textContent = `Attempt #${attemptCount} - Triggering lead...`;

					try {
						const result = await triggerLead(webhookUrl);

						if (result.status === 'success') {
							// Success! Stop the loop
							statusMessage.textContent = '‚úì Success! Lead passed filters and sent to customer.';
							statusMessage.className = 'text-green-600 font-bold italic';
							autoRetryActive = false;

							// Refresh page after 2 seconds to show the result
							setTimeout(() => {
								window.location.reload();
							}, 2000);
							break;
						} else if (result.status === 'filtered') {
							filteredCount++;
							document.getElementById('filteredCount').textContent = filteredCount;
							statusMessage.textContent = `Filtered: ${result.reason}`;
						} else if (result.status === 'error') {
							errorCount++;
							document.getElementById('errorCount').textContent = errorCount;
							statusMessage.textContent = `Error: ${result.reason || 'Unknown error'}`;
						}

						// Add a small delay between attempts
						if (autoRetryActive) {
							await new Promise(resolve => setTimeout(resolve, 1500));
						}

					} catch (error) {
						errorCount++;
						document.getElementById('errorCount').textContent = errorCount;
						statusMessage.textContent = `Error: ${error.message}`;

						// Wait before retrying on error
						await new Promise(resolve => setTimeout(resolve, 2000));
					}

					// Safety limit: stop after 50 attempts
					if (attemptCount >= 50) {
						statusMessage.textContent = '‚ö†Ô∏è Reached maximum attempts (50). Stopping.';
						statusMessage.className = 'text-red-600 font-bold italic';
						autoRetryActive = false;
					}
				}

				// Reset UI
				autoRetryButton.disabled = false;
				triggerButton.disabled = false;
				autoRetrySpinner.classList.add('hidden');
				autoRetryText.textContent = 'Auto-Generate Until Success';
				stopButton.classList.add('hidden');
			});

			// Stop button handler
			document.getElementById('stopButton').addEventListener('click', function () {
				autoRetryActive = false;
				document.getElementById('statusMessage').textContent = 'Stopped by user.';
				document.getElementById('statusMessage').className = 'text-gray-600 italic';
			});

			// Auto-clear success message
			const urlParams = new URLSearchParams(window.location.search);
			if (urlParams.get('success') === 'true') {
				// Clear the success parameter after showing message
				setTimeout(() => {
					window.history.replaceState({}, document.title, window.location.pathname);
				}, 3000);
			}
	</script>
</body>

</html>